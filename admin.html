<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Digital Library</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #435f4a; }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; color: #435f4a; margin: 10px 0; }
        .stat-label { color: #666; font-size: 14px; }
        .admin-actions { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-group textarea { height: 100px; resize: vertical; }
        .btn-admin { background: #435f4a; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
        .btn-admin:hover { background: #324a38; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .books-list { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .book-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .book-item:last-child { border-bottom: none; }
        .book-info h4 { margin: 0 0 5px 0; color: #333; }
        .book-meta { color: #666; font-size: 14px; }
        .book-actions { display: flex; gap: 10px; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .edit-btn { background: #ffc107; color: #333; }
        .delete-btn { background: #dc3545; color: white; }
        .admin-section { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 class="logo">Admin Dashboard</h2>
            <div class="section">
                <h3>Navigation</h3>
                <a href="index.html" class="nav-link">‚Üê Back to Catalogue</a>
                <a href="#" onclick="showSection('dashboard')" class="nav-link">üìä Dashboard</a>
                <a href="#" onclick="showSection('addBook')" class="nav-link">üìö Add New Book</a>
                <a href="#" onclick="showSection('manageBooks')" class="nav-link">üìñ Manage Books</a>
                <a href="#" onclick="showSection('users')" class="nav-link">üë• Manage Users</a>
            </div>
            <div class="section">
                <h3>Quick Stats</h3>
                <div id="quickStats"><p>Loading statistics...</p></div>
            </div>
            <div class="section">
                <button class="btn-admin" onclick="logoutUser()" style="width: 100%;">Logout</button>
            </div>
        </aside>
        
        <main class="content">
            <div class="admin-header">
                <h2>Library Administration</h2>
                <div class="profile">
                    <img src="pfp.jpeg" alt="profile picture">
                    <span id="adminName">Loading...</span>
                </div>
            </div>
            
            <div id="dashboardSection" class="admin-section">
                <h3>üìä Overview</h3>
                <div class="admin-stats">
                    <div class="stat-card"><div class="stat-number" id="totalBooks">0</div><div class="stat-label">Total Books</div></div>
                    <div class="stat-card"><div class="stat-number" id="availableBooks">0</div><div class="stat-label">Available Books</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalUsers">0</div><div class="stat-label">Total Users</div></div>
                    <div class="stat-card"><div class="stat-number" id="activeBorrows">0</div><div class="stat-label">Active Borrows</div></div>
                </div>
                <div class="admin-actions">
                    <h4>Quick Actions</h4>
                    <button class="btn-admin" onclick="showSection('addBook')">‚ûï Add New Book</button>
                    <button class="btn-admin" onclick="loadBooksAdmin()">üîÑ Refresh Books List</button>
                    <button class="btn-admin" onclick="showSection('users')">üë• View All Users</button>
                </div>
            </div>
            
            <div id="addBookSection" class="admin-section">
                <h3>üìö Add New Book</h3>
                <div class="admin-actions">
                    <form id="addBookForm">
                        <div class="form-grid">
                            <div class="form-group"><label for="bookTitle">Title *</label><input type="text" id="bookTitle" required></div>
                            <div class="form-group"><label for="bookAuthor">Author *</label><input type="text" id="bookAuthor" required></div>
                            <div class="form-group"><label for="bookISBN">ISBN</label><input type="text" id="bookISBN"></div>
                            <div class="form-group"><label for="bookCategory">Category</label>
                                <select id="bookCategory">
                                    <option value="Fiction">Fiction</option><option value="Nonfiction">Nonfiction</option>
                                    <option value="Business">Business</option><option value="Technology">Technology</option>
                                    <option value="Science">Science</option><option value="Biography">Biography</option>
                                    <option value="Mystery">Mystery</option><option value="Self-help">Self-help</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="bookCopies">Copies *</label><input type="number" id="bookCopies" value="1" min="1" required></div>
                            <div class="form-group"><label for="bookYear">Year</label><input type="number" id="bookYear" min="1900" max="2025"></div>
                        </div>
                        <div class="form-group"><label for="bookDescription">Description</label><textarea id="bookDescription"></textarea></div>
                        <button type="button" class="btn-admin" onclick="addBookAdmin()">Add Book</button>
                        <button type="button" class="btn-admin" onclick="resetBookForm()" style="background: #6c757d;">Clear Form</button>
                    </form>
                </div>
            </div>
            
            <div id="manageBooksSection" class="admin-section">
                <h3>üìñ Manage Books</h3>
                <div class="books-list">
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="searchBooks" placeholder="Search books..." style="width: 300px; padding: 10px;">
                        <button class="btn-admin" onclick="searchBooksAdmin()">Search</button>
                        <button class="btn-admin" onclick="loadBooksAdmin()" style="background: #6c757d;">Show All</button>
                    </div>
                    <div id="booksList"><p>Loading books...</p></div>
                </div>
            </div>
            
            <div id="usersSection" class="admin-section">
                <h3>üë• Manage Users</h3>
                <div class="admin-actions"><div id="usersList"><p>Loading users...</p></div></div>
            </div>
        </main>
    </div>
    
    <script src="script.js"></script>
    <script>
    // Simple admin dashboard
    document.addEventListener('DOMContentLoaded', function() {
        checkAdminAccess();
        loadDashboard();
    });
    
    function checkAdminAccess() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const token = localStorage.getItem('token');
        if (!user || !token || user.role !== 'admin') {
            alert('Admin access required');
            window.location.href = 'login.html';
            return;
        }
        document.getElementById('adminName').textContent = user.email + ' (Admin)';
    }
    
    function showSection(section) {
        ['dashboard', 'addBook', 'manageBooks', 'users'].forEach(s => {
            document.getElementById(s + 'Section').style.display = 'none';
        });
        document.getElementById(section + 'Section').style.display = 'block';
    }
    
    async function loadDashboard() {
        try {
            const stats = await apiCall('/api/books/stats/overview');
            document.getElementById('totalBooks').textContent = stats.total_books || 0;
            document.getElementById('availableBooks').textContent = stats.available_books || 0;
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('activeBorrows').textContent = stats.active_borrows || 0;
            document.getElementById('quickStats').innerHTML = `
                <p>üìö Books: ${stats.total_books || 0}</p>
                <p>üë• Users: ${stats.total_users || 0}</p>
                <p>üìñ Active: ${stats.active_borrows || 0}</p>
            `;
        } catch (e) {
            console.error('Stats error:', e);
        }
        await loadBooksAdmin();
        await loadUsersAdmin();
        showSection('dashboard');
    }
    
    async function loadBooksAdmin() {
        try {
            const books = await loadBooks();
            let html = '';
            books.forEach(book => {
                html += `<div class="book-item">
                    <div class="book-info">
                        <h4>${book.title}</h4>
                        <p>${book.author} | ${book.category} | Copies: ${book.available_copies}/${book.copies}</p>
                    </div>
                    <div class="book-actions">
                        <button class="action-btn edit-btn" onclick="editBookPrompt(${book.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteBookAdmin(${book.id})">Delete</button>
                    </div>
                </div>`;
            });
            document.getElementById('booksList').innerHTML = html || '<p>No books</p>';
        } catch (e) {
            document.getElementById('booksList').innerHTML = '<p>Error loading books</p>';
        }
    }
    
    async function loadUsersAdmin() {
        try {
            const users = await loadAllUsers();
            let html = '';
            users.forEach(user => {
                html += `<div class="book-item">
                    <div class="book-info">
                        <h4>${user.email}</h4>
                        <p>${user.name || 'No name'} | Role: ${user.role}</p>
                    </div>
                    <div class="book-actions">
                        <button class="action-btn edit-btn" onclick="editUserPrompt(${user.id})">Edit Role</button>
                        ${user.role !== 'admin' ? `<button class="action-btn delete-btn" onclick="deleteUserAdmin(${user.id})">Delete</button>` : ''}
                    </div>
                </div>`;
            });
            document.getElementById('usersList').innerHTML = html || '<p>No users</p>';
        } catch (e) {
            document.getElementById('usersList').innerHTML = '<p>Error loading users</p>';
        }
    }
    
    async function addBookAdmin() {
        const book = {
            title: document.getElementById('bookTitle').value,
            author: document.getElementById('bookAuthor').value,
            isbn: document.getElementById('bookISBN').value || null,
            category: document.getElementById('bookCategory').value,
            copies: parseInt(document.getElementById('bookCopies').value),
            description: document.getElementById('bookDescription').value || '',
            available_copies: parseInt(document.getElementById('bookCopies').value)
        };
        try {
            await apiCall('/api/books', 'POST', book);
            alert('Book added!');
            resetBookForm();
            await loadDashboard();
            showSection('manageBooks');
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }
    
    async function deleteBookAdmin(bookId) {
        if (!confirm('Delete this book?')) return;
        try {
            await apiCall(`/api/books/${bookId}`, 'DELETE');
            alert('Book deleted!');
            await loadBooksAdmin();
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }
    
    async function deleteUserAdmin(userId) {
        if (!confirm('Delete this user?')) return;
        try {
            await apiCall(`/api/users/${userId}`, 'DELETE');
            alert('User deleted!');
            await loadUsersAdmin();
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }
    
    function resetBookForm() {
        document.getElementById('addBookForm').reset();
    }
    
    function editBookPrompt(id) {
        alert('Edit book ' + id + ' - Feature coming soon!');
    }
    
    function editUserPrompt(id) {
        alert('Edit user ' + id + ' - Feature coming soon!');
    }
    
    function searchBooksAdmin() {
        const term = document.getElementById('searchBooks').value.toLowerCase();
        const items = document.querySelectorAll('.book-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(term) ? 'flex' : 'none';
        });
    }
    
    // Make functions global
    window.showSection = showSection;
    window.loadBooksAdmin = loadBooksAdmin;
    window.searchBooksAdmin = searchBooksAdmin;
    window.addBookAdmin = addBookAdmin;
    window.deleteBookAdmin = deleteBookAdmin;
    window.deleteUserAdmin = deleteUserAdmin;
    window.resetBookForm = resetBookForm;
    </script>
</body>
</html>
